<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leave Management System</title>
<link rel="stylesheet" href="ui.css">
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#93c5fd,#bfdbfe);
    margin: 0; padding: 0;
    min-height: 100vh;
    display: flex; justify-content: center; align-items: center;
  }
  .box {
    background: black;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    width: 700px;
  }
  h2,h3 {
    text-align: center;
    color:#2563eb;
  }
  input,select,textarea {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 15px;
  }
  button {
    background:#2563eb;
    color:#fff;
    border:none;
    padding:10px 20px;
    border-radius:5px;
    cursor:pointer;
    margin-top:10px;
  }
  button:hover{background:#1e40af;}
  .error{color:red;text-align:center;}
  .request-card{
    background:black;
    padding:15px;margin-top:10px;
    border-left:5px solid #2563eb;
    border-radius:5px;
  }
  .approved{border-left:5px solid #22c55e;background:black;}
  .rejected{border-left:5px solid #ef4444;background:black;}
  .buttons{margin-top:10px;}
  .approve-btn,.reject-btn{
    border:none;padding:6px 12px;border-radius:5px;cursor:pointer;margin-right:5px;font-size:14px;
  }
  .approve-btn{background:#22c55e;color:#fff;}
  .approve-btn:hover{background:#16a34a;}
  .reject-btn{background:#ef4444;color:#fff;}
  .reject-btn:hover{background:#b91c1c;}
</style>
</head>
<body>
<div class="bg-blob" aria-hidden="true"></div>

<!-- Login Box -->
<div class="box container-glass" id="loginBox">
  <h2>Login</h2>
  <select id="role">
    <option value="student">Student</option>
    <option value="teacher">Teacher</option>
    <option value="admin">Admin</option>
  </select>
  <input type="email" id="userid" placeholder="Email">
  <input type="password" id="password" placeholder="Password (min 6 chars)">
  <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button onclick="login()">Sign In</button>
    <button onclick="signup()">Sign Up</button>
    <button onclick="googleLogin()" style="background:#ef4444;">Sign in with Google</button>
  </div>
  <div class="error" id="error"></div>
  <p style="font-size:12px;color:#555;text-align:center;margin-top:8px;">Selected role is applied only on first sign in; admins can update in Firestore later.</p>
</div>

<!-- Main Box -->
<div class="box container-glass" id="mainBox" style="display:none;">
  <h2>Leave Management System</h2>
  <p style="text-align:center;">Logged in as <b><span id="currentRole"></span></b> 
  <button onclick="logout()">Logout</button></p>

  <!-- Leave Form Section -->
  <div id="leaveFormSection">
    <h3>Submit Leave Application</h3>
    <form id="leaveForm">
      <input type="text" id="studentName" placeholder="Your Name" required>
      <textarea id="leaveReason" placeholder="Reason for Leave" rows="3" required></textarea>
      <select id="leaveDays" required>
        <option value="">Select Days</option>
        <option value="1">1 Day</option>
        <option value="2">2 Days</option>
        <option value="3">3 Days</option>
        <option value="More">More than 3 Days</option>
      </select>
      <button type="submit">Submit</button>
    </form>
  </div>

  <!-- Applications -->
  <h3>All Leave Applications</h3>
  <div id="requestList"></div>
</div>

<script>
  let currentRole=null;
  let currentUser=null;

  const errEl = document.getElementById('error');

  function setError(msg){ errEl.textContent = msg || ''; }

  // Auth state
  function initAuth(){
    if (!window.auth) return setError('Auth unavailable.');
    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      if (user) {
        // Fetch or set role from Firestore users doc
        try {
          await ensureUserDoc(user);
          let roleSel = document.getElementById('role').value;
          const userRef = db.collection('users').doc(user.uid);
          const snap = await userRef.get();
          const existingRole = snap.exists ? (snap.data().role || null) : null;
          if (!existingRole) {
            await userRef.set({ role: roleSel }, { merge: true });
            currentRole = roleSel;
          } else {
            currentRole = existingRole;
          }
        } catch(e){ console.warn(e); }
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('mainBox').style.display = 'block';
        document.getElementById('currentRole').textContent = (currentRole||'user').toUpperCase();
        document.getElementById('leaveFormSection').style.display = currentRole==='admin' ? 'none' : 'block';
        subscribeApplications();
      } else {
        document.getElementById('loginBox').style.display = 'block';
        document.getElementById('mainBox').style.display = 'none';
      }
    });
  }

  async function login(){
    setError('');
    const email = document.getElementById('userid').value.trim();
    const pass = document.getElementById('password').value;
    try { await auth.signInWithEmailAndPassword(email, pass); } catch(e){ setError(e.message||'Login failed'); }
  }
  async function signup(){
    setError('');
    const email = document.getElementById('userid').value.trim();
    const pass = document.getElementById('password').value;
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await ensureUserDoc(cred.user);
    } catch(e){ setError(e.message||'Signup failed'); }
  }
  async function googleLogin(){
    setError('');
    try { await signInWithGoogle(); } catch(e){ setError(e.message||'Google sign-in failed'); }
  }
  async function logout(){
    try { await auth.signOut(); } catch(e){ console.error(e); }
  }

  // Firestore: leave applications
  let unsubApps = null;
  function subscribeApplications(){
    if (!window.db) return;
    unsubApps && unsubApps();
    unsubApps = db.collection('leave_applications').orderBy('createdAt','desc')
      .onSnapshot(snap => {
        const apps = [];
        snap.forEach(doc => apps.push({ id: doc.id, ...doc.data() }));
        renderApplications(apps);
      });
  }

  document.getElementById('leaveForm').addEventListener('submit', async function(e){
    e.preventDefault();
    if (!currentUser) { setError('Sign in required'); return; }
    const name=document.getElementById('studentName').value;
    const reason=document.getElementById('leaveReason').value;
    const days=document.getElementById('leaveDays').value;
    try {
      await db.collection('leave_applications').add({
        name, reason, days,
        status: 'pending',
        submittedByUid: currentUser.uid,
        submittedByRole: currentRole,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      this.reset();
    } catch(e){ setError('Failed to submit: ' + (e.message||'')); }
  });

  function renderApplications(leaveApplications){
    const container=document.getElementById('requestList');
    container.innerHTML="";
    leaveApplications.forEach(app=>{
      const card=document.createElement('div');
      card.className='request-card';
      if(app.status==='approved')card.classList.add('approved');
      if(app.status==='rejected')card.classList.add('rejected');
      card.innerHTML=`<b>${app.name}</b> (${app.submittedByRole||'user'}) requested <b>${app.days}</b> day(s)<br>Reason: ${app.reason}<br>Status: <b>${app.status}</b>`;
      // Approve / Reject logic
      const canModerate = currentRole==='admin' || currentRole==='teacher';
      const canTeacherAct = currentRole==='teacher' && (app.submittedByRole==='student');
      if (app.status==='pending' && (currentRole==='admin' || canTeacherAct)){
        const btns=document.createElement('div');
        btns.className='buttons';
        const approve=document.createElement('button');
        approve.className='approve-btn';
        approve.textContent='Approve';
        approve.onclick=()=>updateStatus(app.id,'approved');
        const reject=document.createElement('button');
        reject.className='reject-btn';
        reject.textContent='Reject';
        reject.onclick=()=>updateStatus(app.id,'rejected');
        btns.appendChild(approve); btns.appendChild(reject);
        card.appendChild(btns);
      }
      container.appendChild(card);
    });
  }

  async function updateStatus(id,status){
    try { await db.collection('leave_applications').doc(id).set({ status }, { merge: true }); }
    catch(e){ setError('Failed to update: ' + (e.message||'')); }
  }

  // Initialize after SDKs load
  window.addEventListener('load', () => { setTimeout(initAuth, 0); });
</script>

<!-- Firebase SDKs and shared scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="auth.js"></script>

</body>
</html>
